<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="css/styles.css" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>De Bibliotheek Van De Toekomst</title>
    
    <!-- dit is de bootstrap link-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="js/script.js"></script>
    <style>
      .row{
        width: 27em;
      }
      input::-webkit-outer-spin-button,
      input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .custom-button[disabled] {
        background-color: #eca3a9; /* Change the background color to a light red */
        cursor: not-allowed;
      }
    </style>
  </head>

  <body onload=loadAll(id)>
    <div id="content">
      <div class="container">

        <div class="container">
          <div class="row">
            <div class="col input-group">
              <button type="button" class="btn btn-outline-secondary" id="decrement">-</button>
              <input type="number" class="form-control text-center" id="number" min="1" max="20" value="1">
              <button type="button" class="btn btn-outline-secondary" id="increment">+</button>
            </div>
            <div class="col">
              <button class="btn btn-primary btn-outline-secondary border rounded-pill text-dark fw-bold" type="button" onclick="createBookCopy()">Exemplaar toevoegen</button>
            </div>
          </div>
        </div>

        <h3 id="header"></h2>
        <div class="container" id="booksContainer"></div>
        <h3>Gearchiveerde exemplaren</h3>
        <div class="container" id="archivedContainer"></div>
      </div>
    </div>
    

    <script>
      id = parseInt(localStorage.getItem('WT_book'));
      console.log("id="+id)

      document.addEventListener('DOMContentLoaded', function () {
        const numberInput = document.getElementById('number');
        const incrementButton = document.getElementById('increment');
        const decrementButton = document.getElementById('decrement');

        incrementButton.addEventListener('click', function () {
          let currentValue = parseInt(numberInput.value);
          if (currentValue < 20) {
            numberInput.value = currentValue + 1;
          }
        });

        decrementButton.addEventListener('click', function () {
          let currentValue = parseInt(numberInput.value);
          if (currentValue > 1) {
            numberInput.value = currentValue - 1;
          }
        });
      });

      if (!isAdmin()) {
        window.location.href = '/index.html';
      }

      function loadAll(id){         
        getBook(id).then(data => {
            console.log("boek data=" + data)
            document.getElementById('header').innerHTML = `Exemplaren van <i>${data.title}, ${data.author}</i>`;
        });
        getBookCopies(id).then(data => {
          console.log("boekcopy data=" + data)
          renderCopies(data)
        });
      }

      async function getBook(id) {
        try {
        const response = await fetch(`http://localhost:8080/book/information/${id}`, {
        method: 'GET',
        });
        
        //if it doesn't work throw error
        if (!response.ok) {
        throw new Error(`Error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log(data)
        return data;
        } catch (error) {
            console.log(error);
        }
      }

      async function getBookCopies(id) {
        try {
        const response = await fetch(`http://localhost:8080/bookcopy/book/${id}`, {
        method: 'GET',
        });
        
        //if it doesn't work throw error
        if (!response.ok) {
        throw new Error(`Error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log(data)
        return data;
        } catch (error) {
            console.log(error);
        }
      }


      function renderCopies(book) {
        let table = `
            <table class="table">
              <thead>
                <tr>
                  <th>Exemplaarnummer</th>
                  <th>Beschikbaar</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
            `;
        
        let tableArchived = `
            <table class="table">
              <thead>
                <tr>
                  <th>Exemplaarnummer</th>
                  <th>Beschikbaar</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
            `;

        book.forEach(copy => {
          let availability = "";
          if (copy.available == 1) {
            availability = "Beschikbaar";
          } else {
            availability = "Niet beschikbaar";
          }
          

          if (copy.archived == 0) {
            console.log("DATA: "+ copy.archived)
            table += `
              <tr data-id="${copy.id}">  
                <td>${copy.copyNumber}</td>
                <td>${availability}</td>
                <td>
                  
            `
            if (copy.available == 1) {
              table += `<button type="button" class="btn btn-danger btn-outline-secondary border rounded-pill fw-bold" id="archiveren_${copy.id}" onclick="archiveBookCopy(${copy.id})">
                    Archiveren
                  </button>
                </td>
              </tr>`
            } else {
              table += `<button type="button" class="btn btn-danger btn-outline-secondary border rounded-pill fw-bold custom-button" id="archiveren_${copy.id}" onclick="archiveBookCopy(${copy.id})" disabled>
                    Archiveren
                  </button>
                </td>
              </tr>`
            }

          } else {
            tableArchived += `
              <tr data-id="${copy.id}">  
                <td>${copy.copyNumber}</td>
                <td>${availability}</td>
                <td>
                  <button type="button" class="btn btn-danger btn-outline-secondary border rounded-pill fw-bold" id="dearchiveren_${copy.id}" onclick="unarchiveBookCopy(${copy.id})">
                    Dearchiveren
                  </button>
                </td>
              </tr>
            `
          }

        });

        let endtable = `
          </tbody>
          </table>
        `;

        document.getElementById('booksContainer').innerHTML = table+endtable;
        document.getElementById('archivedContainer').innerHTML = tableArchived+endtable;
      }

      async function createBookCopy() {
        let numberInput = document.getElementById("number").value;
        // getHighestBookNumber().then(number => {
        //     console.log("boekNumber=" + number)
        // });
        for (let i=1; i<= numberInput; i++){
          let obj = {
          "available": true,
          "book": id
          }
          console.log(obj)
          try {
            
            const response = await fetch(`http://localhost:8080/bookcopy/save`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                "Authorization": localStorage.getItem("WT_TOKEN")
              },
              body: JSON.stringify(obj),
            });

            if (response.ok) {
              // Book copy saved successfully
              console.log(`Book copy`);
            } else {
              // Handle any errors
              console.error(`Failed to save book copy.`);
            }
          } catch (error) {
            console.error(`An error occurred while saving book copy: ${error}`);
          }
        }
        location.reload();
      }

      async function archiveBookCopy(id) {
        try {
          const response = await fetch(
            `http://localhost:8080/bookcopy/archive/${id}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                "Authorization": localStorage.getItem("WT_TOKEN"),
              }
            });
          if (!response.ok) {
            throw new Error(`Error! status: ${response.status}`);
          }
          const data = await response.json();
          location.reload();
          alert("Boek exemplaar gearchiveerd!")
          return data;
        } catch (error) {
          console.log(error);
        }
      }

      async function unarchiveBookCopy(id) {
        try {
          const response = await fetch(
            `http://localhost:8080/bookcopy/unarchive/${id}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                "Authorization": localStorage.getItem("WT_TOKEN"),
              }
            });
          if (!response.ok) {
            throw new Error(`Error! status: ${response.status}`);
          }
          const data = await response.json();
          location.reload();
          alert("Boek exemplaar gedearchiveerd!")
          return data;
        } catch (error) {
          console.log(error);
        }        
      }

      
      

    </script>

    <!-- dit is de bootstrap link-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  </div>

  </body>
</html>