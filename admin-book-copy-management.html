<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="css/styles.css" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>De Bibliotheek Van De Toekomst</title>
    
    <!-- dit is de bootstrap link-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .row{
        width: 27em;
      }
      input::-webkit-outer-spin-button,
      input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
    </style>
  </head>

  <body onload=loadAll(id)>

    <div class="container">

      <div class="container">
        <div class="row">
          <div class="col input-group">
            <button type="button" class="btn btn-outline-secondary" id="decrement">-</button>
            <input type="number" class="form-control text-center" id="number" min="1" max="20" value="1">
            <button type="button" class="btn btn-outline-secondary" id="increment">+</button>
          </div>
          <div class="col">
            <button class="btn btn-primary btn-outline-secondary border rounded-pill text-dark fw-bold" type="button" onclick="createBookCopy()">Exemplaar toevoegen</button>
          </div>
        </div>
      </div>
      
      

      

      <h2 id="header"></h2>
      <div class="container" id="booksContainer"></div>
    </div>
    

    <div id="content" style="display: none">
    
    </div>
    

    <script>
      id = parseInt(localStorage.getItem('WT_book'));
      console.log("id="+id)

      document.addEventListener('DOMContentLoaded', function () {
        const numberInput = document.getElementById('number');
        const incrementButton = document.getElementById('increment');
        const decrementButton = document.getElementById('decrement');

        incrementButton.addEventListener('click', function () {
          let currentValue = parseInt(numberInput.value);
          if (currentValue < 20) {
            numberInput.value = currentValue + 1;
          }
        });

        decrementButton.addEventListener('click', function () {
          let currentValue = parseInt(numberInput.value);
          if (currentValue > 1) {
            numberInput.value = currentValue - 1;
          }
        });
      });

      function authenticate(){
        document.addEventListener('DOMContentLoaded', function () {
            fetch(`http://localhost:8080/authenticate/admin`, {
                  method: "POST",
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                  userId: localStorage.getItem("WT_ID"),
                  role: localStorage.getItem("WT_ROLE"),
                  token: localStorage.getItem("WT_TOKEN")
                  })
                })
                .then(response => response.json())
                .then(data => {
                  console.log(data)
                    if (data) {
                        document.getElementById('content').style.display = 'block';
                    } else {
                        document.getElementById('access-denied-message').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });

      }

      function loadAll(id){         
        getBook(id).then(data => {
            console.log("boek data=" + data)
            document.getElementById('header').innerHTML = `Exemplaren van <i>${data.title}, ${data.author}</i>`;
        });
        getBookCopies(id).then(data => {
          console.log("boekcopy data=" + data)
          renderCopies(data)
        });
      }

      async function getBook(id) {
        try {
        const response = await fetch(`http://localhost:8080/book/information/${id}`, {
        method: 'GET',
        });
        
        //if it doesn't work throw error
        if (!response.ok) {
        throw new Error(`Error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log(data)
        return data;
        } catch (error) {
            console.log(error);
        }
      }

      async function getBookCopies(id) {
        try {
        const response = await fetch(`http://localhost:8080/bookcopy/book/${id}`, {
        method: 'GET',
        });
        
        //if it doesn't work throw error
        if (!response.ok) {
        throw new Error(`Error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log(data)
        return data;
        } catch (error) {
            console.log(error);
        }
      }


      function renderCopies(book) {
        let table = `
            <table class="table">
              <thead>
                <tr>
                  <th>Exemplaarnummer</th>
                  <th>Beschikbaar</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
            `;

        book.forEach(copy => {
          let availability = "";
          if (copy.available == 1) {
            availability = "Beschikbaar";
          } else {
            availability = "Nier beschikbaar";
          }
          table += `
            <tr data-id="${copy.id}">  
              <td>${copy.copyNumber}</td>
              <td>${availability}</td>
              <td>
                <button type="button" class="btn btn-danger btn-outline-secondary border rounded-pill fw-bold" id="delete_${copy.id}" onclick="delBookCopy(${copy.id})">
                  Verwijderen
                </button>
              </td>
            </tr>
          `
        });
        table += `
          </tbody>
          </table>
        `;

        document.getElementById('booksContainer').innerHTML = table;
      }

      // async function getHighestBookNumber() {
      //   try {
      //     const response = await fetch(`http://localhost:8080/highest-copy-number`, {
      //     method: 'GET',
      //   });
        
      //   //if it doesn't work throw error
      //   if (!response.ok) {
      //   throw new Error(`Error! status: ${response.status}`);
      //   }

      //   const data = await response.json();
      //   console.log(data)
      //   return data;
      //   } catch (error) {
      //       console.log(error);
      //   }
      // }

      async function createBookCopy() {
        let numberInput = document.getElementById("number").value;
        // getHighestBookNumber().then(number => {
        //     console.log("boekNumber=" + number)
        // });
        for (let i=1; i<= numberInput; i++){
          let obj = {
          "available": true,
          "copyNumber": i,
          "book": id
          }
          console.log(obj)
          try {
            
            const response = await fetch(`http://localhost:8080/bookcopy/save`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                "Authorization": localStorage.getItem("WT_TOKEN")
              },
              body: JSON.stringify(obj),
            });

            if (response.ok) {
              // Book copy saved successfully
              console.log(`Book copy`);
            } else {
              // Handle any errors
              console.error(`Failed to save book copy.`);
            }
          } catch (error) {
            console.error(`An error occurred while saving book copy: ${error}`);
          }
        }
        location.reload();
      }

      
      

    </script>

    <script src="js/script.js" defer></script>
    <!-- dit is de bootstrap link-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  </div>
  <div id="access-denied-message" style="display: none">
    <p>Access Denied</p>
  </div>
  <script>authenticate()</script>
  </body>
</html>