<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />

    <title>Document</title>
    <style>
      .fa {
        font-size: 1.5em;
        color: gray;
        cursor: pointer;
      }

      .fa:hover {
        color: orange;
      }
    </style>
  </head>
  <body>
    <table class="table table-striped" id="books-table"></table>

    <!-- Modal to write Review -->
    <div
      class="modal fade"
      id="reviewModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="reviewModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <!-- Modal header -->
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="reviewModalLabel">
              Review Toevoegen
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
              onclick="resetForm()"
            ></button>
          </div>
          <!-- Modal body -->
          <div class="modal-body">
            <div id="bookInfo"></div>

            <!-- Star rating -->
            <div id="rating" data-rating="0">
              <span class="fa fa-star" data-star="1"></span>
              <span class="fa fa-star" data-star="2"></span>
              <span class="fa fa-star" data-star="3"></span>
              <span class="fa fa-star" data-star="4"></span>
              <span class="fa fa-star" data-star="5"></span>
            </div>
            <br />

            <!-- Review text -->
            <div class="mb-3">
              <label for="reviewText" class="form-label">Review</label>
              <textarea
                class="form-control"
                id="reviewText"
                rows="3"
                oninput="checkEmpty()"
              ></textarea>
            </div>
          </div>

          <!-- Modal footer -->
          <div id="footerButtons" class="modal-footer"></div>
        </div>
      </div>
    </div>

    <script>
      // Check if user clicked a star to enable the save button
      var starElements = document.querySelectorAll("#rating [data-star]");

      starElements.forEach(function (star) {
        star.addEventListener("click", function () {
          var starRating = star.getAttribute("data-star");
          document
            .getElementById("rating")
            .setAttribute("data-rating", starRating);
          checkEmpty();
        });
      });

      // Check if user has written a review and clicked a star to enable the save button
      function checkEmpty() {
        let reviewText = document.getElementById("reviewText").value;
        let rating = document
          .getElementById("rating")
          .getAttribute("data-rating");

        let saveButton = document.getElementById("save-button");
        saveButton.disabled = reviewText.length <= 0 || rating === "0";
      }

      // Function to reset the modal after closing it
      function resetForm() {
        // Clear the textarea content
        document.getElementById("reviewText").value = "";

        // Reset the star rating
        document.getElementById("rating").setAttribute("data-rating", "0");
        const stars = document.querySelectorAll(".fa");
        stars.forEach((star) => {
          star.style.color = "gray";
        });
      }

      // Add a click event listener to each star icon
      const stars = document.querySelectorAll(".fa");
      stars.forEach((star) => {
        star.addEventListener("click", () => {
          const rating = parseInt(star.getAttribute("data-star"));
          document.getElementById("rating").setAttribute("data-rating", rating);
          highlightStars(rating);
        });
      });

      // Highlight stars based on the selected rating
      function highlightStars(rating) {
        stars.forEach((star) => {
          const starRating = parseInt(star.getAttribute("data-star"));
          if (starRating <= rating) {
            star.style.color = "orange";
          } else {
            star.style.color = "gray";
          }
        });
      }

      // Save review object in database
      function opslaan(bookId) {
        let reviewStars = document
          .getElementById("rating")
          .getAttribute("data-rating");
        let reviewText = document.getElementById("reviewText").value;
        let userId = localStorage.getItem("WT_ID");
        console.log(userId);

        let obj = {
          stars: reviewStars,
          text: reviewText,
          bookId: bookId,
          userId: userId,
        };

        fetch("http://localhost:8080/review/save", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: localStorage.getItem("WT_TOKEN"),
          },
          body: JSON.stringify(obj),
        })
          .then((response) => response.json())
          .then((success) => {
            if (success) {
              alert("Review Opgeslagen");
              location.reload();
            } else {
              alert("Er is iets mis gegaan.");
            }
          });
      }

      function getBookInfo(bookId) {
        return fetch(`http://localhost:8080/book/info/${bookId}`).then(
          (response) => {
            return response.json();
          }
        );
      }

      // Fetch book information and update the modal content
      function fetchBookInfo(bookId) {
        getBookInfo(bookId).then((bookInfo) => {
          let modal = document.getElementById("reviewModal");
          let bookInfoSection = modal.querySelector("#bookInfo");
          let saveButton = modal.querySelector("#footerButtons");

          // Update the modal with book information
          let authorName = bookInfo.author;
          let title = bookInfo.title;
          let coverUrl = bookInfo.coverUrl;
          bookInfoSection.innerHTML = `<img src="${coverUrl}" width="200" height="300"><h2>${title}, ${authorName}</h2> <br><br>`;
          saveButton.innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="resetForm()">Sluiten</button>
                                            <button id="save-button" type="button" class="btn btn-primary" onclick="opslaan(${bookId})" disabled>Opslaan</button>`;
        });
      }

      function findAll() {
        console.log("start met ophalen");
        fetch("http://localhost:8080/book/all")
          .then((response) => response.json())
          .then((data) => {
            console.log("Data", data);
            let html = "";
            data.forEach((book) => {
              html += `
                            <tr>
                                <td>${book.id}</td>
                                <td>${book.title}</td>
                                <td><button onclick="fetchBookInfo(${book.id})" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reviewModal">Review Toevoegen</button></td>
                            </tr>
                        `;
            });
            document.getElementById("books-table").innerHTML = html;
          });
        console.log("Na fetch");
      }

      findAll();
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
