<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <!-- dit is de bootstrap link-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"  rel="stylesheet">
  
  <script>

    async function updateReservationStatus(reservation){
      return new Promise(async (resolve, reject) => {
          try{
            await createBorrowedBook(reservation)
            const response = await fetch(`http://localhost:8080/reservation/${reservation.id}`, {
                  method: "PUT",
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                  borrowed: true
                  })
                })
              if (response.ok) {
                const data = await response.json();
                console.log("Status reservation updated to borrowed:", data);
                resolve(data)
              }
              else{
              console.error("Error updating reservation status to borrowed:", data.statusText);
              reject(data)
            }
            } catch (error) {
            console.error("An error occurred:", error);
            reject(error); // Reject the promise with an error
          }
            
    })
  }

    function borrowConfirmModal(){
      return new Promise(async (resolve, reject) => {
        try{
          const selectBookCopy = document.getElementById("selectBookCopy");
          const selectedIndex = selectBookCopy.selectedIndex;
          const selectedOption = selectBookCopy.options[selectedIndex]
          const Ids = JSON.parse(selectedOption.getAttribute("data-invisible-info"));
          jQuery('#exampleModal').modal('hide');
          selectBookCopy.innerHTML = ""
          const response = await fetch(`http://localhost:8080/borrowed-book/save`, {
                  method: "POST",
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                  userId: Ids.userId,
                  bookCopyId: Ids.bookCopyId,
                  bookTitle: Ids.bookTitle
                  })
                })
          if (response.ok) {
            const data = await response.json();
            console.log("Borrowed book created:", data);
            const bookCopyResponse = await fetch(`http://localhost:8080/bookcopy/${Ids.bookCopyId}`, {
              method: "PUT",
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
              available: false
              })
            })
            if (bookCopyResponse.ok){
                const bookCopyData = await bookCopyResponse.json();
                console.log("Availability of bookcopy changed:", bookCopyData);
                resolve(data); // Resolve the promise with the response data
              }
            else{
              console.error("Error updating availability of bookcopy:", bookCopyResponse.statusText);
              reject(data)
            }
            } else {
            console.error("Error creating borrowed book:", response.statusText);
            reject(response.statusText); // Reject the promise with an error
            }
        } catch (error) {
          console.error("An error occurred:", error);
          reject(error); // Reject the promise with an error
        }
        })
      }
           
    function createBorrowedBook(reservation){
      return new Promise((resolve, reject) => {
        fetch(`http://localhost:8080/book/availability/${reservation.bookId}`, {
        method: "GET",
      })
      .then(response => response.json())
      .then(data => {
        if(data.available.length == 0){
          alert("Er zijn momenteel geen exemplaren beschikbaar!")
          reject("No available book copies");
        }
        else{
        html = ''
        for (let i = 0; i < data.available.length; i++) {
          html += `<option value=${[i+1]} data-invisible-info='{"bookCopyId": ${data.availableIds[i]}, "userId": ${reservation.userId}, "bookTitle": "${reservation.bookTitle}"}'>${data.available[i]}</option>`
        }
        const selectBookCopy = document.getElementById("selectBookCopy");
        selectBookCopy.insertAdjacentHTML('beforeend', html);
        jQuery('#exampleModal').modal('show');
        document.getElementById("createBorrowCloseModal").addEventListener("click", function() {
          selectBookCopy.innerHTML = ""
        });
        document.getElementById("createBorrowConfirmModal").addEventListener("click", async function clickHandler() {
          try {
            createBorrowConfirmModal.removeEventListener("click", clickHandler)
            const responseData = await borrowConfirmModal();
            console.log("Response from borrowConfirmModal:", responseData);
            resolve(responseData)
          } catch (error) {
            console.log("Error in borrowConfirmModal:", error);
            reject(error);
          }
        })
        
      }
    })
    .catch(error => {
      console.log("Error fetching book availability:", error);
      reject(error);
    });
      })
  }

    function deleteTables(){
      const tables = document.querySelectorAll('table');
      tables.forEach(table => {
      const headerRow = table.querySelector('thead tr'); 
      if (headerRow) {
        const rows = table.querySelectorAll('tbody tr'); 
        rows.forEach(row => {
          row.remove();
        });
      } else {
        table.remove();
      }
      });
      return;
    }

    function buildTables(data){
      data.forEach(reservation => {
        if (reservation.deleted || reservation.borrowed){
          return;
        }
        if (!reservation.approved){
          approveButtonText = "Goedkeuren";
          declineButtonText = "Afkeuren";
          tableID = "unapproved"
        }
        if (reservation.approved && !reservation.borrowed){
          approveButtonText = "Uitlenen";
          declineButtonText = "Verwijderen";
          tableID = "approved"
        }
        html = "";
        html += `
        <tr>
          <td>${reservation.id}</td>
          <td>${reservation.userFirstName} ${reservation.userLastName}</td>
          <td>${reservation.bookTitle}</td>
          <td>
            <button type="button" class="btn btn-primary btn-outline-secondary border rounded-pill fw-bold" id="approve_${reservation.id}">
              ${approveButtonText}
            </button>
            <button type="button" class="btn btn-danger btn-outline-secondary border rounded-pill fw-bold" id="decline_${reservation.id}">
              ${declineButtonText}
            </button>
          </td>
        </tr>`;
        const table = document.getElementById(tableID);
        table.insertAdjacentHTML('beforeend', html);
        const approveButton = table.querySelector(`#approve_${reservation.id}`);
        const declineButton = table.querySelector(`#decline_${reservation.id}`);
        approveButton.addEventListener('click', async function clickHandler() {
          if (reservation.approved){
            try{
              const responseData = await updateReservationStatus(reservation)
              console.log("Response from updateReservationStatus:", responseData);
              buildBorrowedBooksTable()
            } catch (error) {
              console.log("(Downstream) error in updateReservationStatus:", error);
          }
        }
          else{
            fetch(`http://localhost:8080/reservation/${reservation.id}`, {
              method: "PUT",
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
              approved: true
              })
            })
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(data => {
              console.log('Reservation status updated');
              deleteTables();
              getReservations();
            })
            .catch(error => {
              console.error('Error updating reservation status:', error);
            });
          };
          approveButton.removeEventListener("click", clickHandler)
          deleteTables();
          getReservations();
          
        });        
        declineButton.addEventListener('click', () => {
          if (reservation.approved){
            confirmation = confirm("Weet je zeker dat je deze reservering wilt verwijderen?")
          }
          if(!reservation.approved){
            confirmation = confirm("Weet je zeker dat je dit reserveringsverzoek wilt verwijderen?")
          }
          if (confirmation){
            fetch(`http://localhost:8080/reservation/${reservation.id}`, {
            method: "PUT",
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              deleted: true
            })
          })
            .then(response => {
              deleteTables();
              getReservations();
            })
          }
        })
      })
      return;
    }

    function buildBorrowedBooksTable(){
      fetch(`http://localhost:8080/borrowed-book/all`, {
        method: "GET",
      })
      .then(response => response.json())
      .then(data => {
        data.forEach(lending => {
          if (lending.returnedDate == null){
            html = "";
            html += `
            <tr>
              <td>${lending.id}</td>
              <td>${lending.userFirstName} ${lending.userLastName}</td>
              <td>${lending.bookTitle}</td>
              <td>${lending.bookCopyId}</td>
              <td>
                <button type="button" class="btn btn-greyscale btn-outline-secondary border rounded-pill fw-bold" id="contact_${lending.id}">
                  Contact
                </button>
                <button type="button" class="btn btn-greyscale btn-outline-secondary border rounded-pill fw-bold" id="return_${lending.id}">
                  Stel beschikbaar
                </button>
              </td>
            </tr>`;
            const table = document.getElementById("borrowed");
            table.insertAdjacentHTML('beforeend', html);
            const contactButton = table.querySelector(`#contact_${lending.id}`);
            const returnButton = table.querySelector(`#return_${lending.id}`);
            returnButton.addEventListener('click', () => {
              confirmation = confirm("Weet je zeker dat je deze uitlening weer beschikbaar wilt stellen?")
              if (confirmation){
              
                
                fetch(`http://localhost:8080/borrowed-book/${lending.id}`, {
                  method: "PUT",
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                  })
                })
                .then(response => {
                  fetch(`http://localhost:8080/bookcopy/${lending.bookCopyId}`, {
                  method: "PUT",
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    available: true 
                  })
                })
                .then(response => {
                  deleteTables();
                  getReservations();
                  buildBorrowedBooksTable();
                })
              })
            }
          })
          contactButton.addEventListener('click', () => {
            console.log(lending)
            const emailAddress = document.getElementById("recipient-name")
            html = ''
            html += `<span type="text" id="recipient-mail-${lending.userId}">${lending.userEmail}</span>`
            emailAddress.insertAdjacentHTML('beforeend', html)
            jQuery('#contactModal').modal('show');
            // const modalFooter = document.getElementById("contact-modal-footer")
            // console.log("hoi")
            document.getElementById("contactmodalsend").addEventListener("click", () => {
              confirmation = confirm("Bevestigen om email te versturen")
              if (confirmation){
                const textBody = document.getElementById("message-text").value
                const subjectBody = document.getElementById("subject-text").value
                const email = lending.userEmail
                fetch(`http://localhost:8080/email/send`, {
                  method: "POST",
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    to: email,
                    subject: subjectBody,
                    message: textBody
                  })
              })
              .then(response => response.text())
              .then(data => {
                console.log(data)
              })
          
              
              
            }
            })
            
            
        });
        }
      })
    })
    }
                  
    function getReservations(){
      fetch(`http://localhost:8080/reservation/all`, {
        method: "GET",
      })
      .then(response => response.json())
      .then(data => {
        buildTables(data)
      })
    return;
    }

    function getBorrowedBooks(){
      fetch(`http://localhost:8080/borrowed-book/all`, {
        method: "GET",
      })
      .then(response => response.json())
      .then(data => {
        buildBorrowedBooksTable(data)
      })
      return;
    }
    
  </script>
  
  </head>

  <body>
    
    <script>
      getReservations()
      buildBorrowedBooksTable()
    </script>

    <nav class="navbar navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <img
          src="https://cdn.thalia.nu/public/thumbnails/partners/logos/WT-Basislogo-RGB_2_medium.png?Key-Pair-Id=K1299LB00EJZ7R"
          alt="WorkingTalent" width="150" 
          />
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="admin-home.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="boeken-overzicht-admin.html">Boeken overzicht</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-statistieken.html">Statistieken</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" aria-current="page" href="admin-book-management.html">Boek management</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-account.html">Account</a>
            </li> 
            <li class="nav-item">
              <a class="nav-link" href="admin-favorites.html">Favorieten</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-users.html">Gebruikers</a>
            </li>
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link" href="index.html" onclick="clearLocalStorage()">Log Uit</a>
              </li>
            </ul>
        </div>
      </div>
    </nav>

    <div class="dashboard-container">
      <h1>Admin dashboard</h1>
      <h4>Reserveringsverzoeken</h4>
      <table class="table table-striped" id = "unapproved">
        <thead>
          <tr>
            <th scope="col"><em>#</em></th>
            <th scope="col"><em>Naam</em></th>
            <th scope="col"><em>Boek</em></th>
            <th scope="col"><em>Actie</em></th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <br>

      <h4>Reserveringen</h4>
      <table class="table table-striped" id = "approved">
        <thead>
          <tr>
            <th scope="col"><em>#</em></th>
            <th scope="col"><em>Naam</em></th>
            <th scope="col"><em>Boek</em></th>
            <th scope="col"><em>Actie</em></th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <br>
      
      <h4>Uitleningen</h4>
      <table class="table table-striped" id = "borrowed">
        <thead>
          <tr>
            <th scope="col"><em>#</em></th>
            <th scope="col"><em>Naam</em></th>
            <th scope="col"><em>Boek</em></th>
            <th scope="col"><em>Exemplaar</em></th>
            <th scope="col"><em>Actie</em></th>
          </tr>
        </thead>
        <tbody>
      </tbody>
      </table>

    </div>

    <!-- Select bookcopy modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Selecteer exemplaar voor uitlening</h5>
            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <select class="form-select" aria-label="Default select example" id = "selectBookCopy">
              <!-- <option selected>Open this select menu</option> -->
            </select>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="createBorrowCloseModal" style="float: right;">Sluiten</button>
            <button type="button" class="btn btn-primary" id="createBorrowConfirmModal" style="float: right;">Exemplaar uitlenen</button>
            <div class="clearfix"></div>
          </div>
          <div class="modal-footer">
            ..
          </div>
        </div>
      </div>
    </div>

    <!-- Contact user modal -->

    <div class="modal fade" id="contactModal" tabindex="-1" role="dialog" aria-labelledby="contactModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="contactModalLabel">New message</h5>
            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="recipient-name" class="col-form-label">Recipient:</label>
                <span type="text" class="form-control" id="recipient-name"></span>
              </div>
              <div class="form-group">
                <label for="subject-text" class="col-form-label">Subject:</label>
                <input type="text" class="form-control" id="subject-text">
              </div>
              <div class="form-group">
                <label for="message-text" class="col-form-label">Message:</label>
                <textarea class="form-control" id="message-text"></textarea>
              </div>
            </form>
          </div>
          <div class="contact-modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="contactmodalclose">Close</button>
            <button type="button" class="btn btn-primary" id = "contactmodalsend">Send message</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function addFooter() {
          const resp = await fetch("footer.html");
          const html = await resp.text();
          document.body.insertAdjacentHTML("beforeend", html);
      }   
      addFooter()
  </script>
    
    <script src="script.js" defer></script>

    <!-- dit is de bootstrap link-->
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    
    <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script> -->
  </body>
</html>