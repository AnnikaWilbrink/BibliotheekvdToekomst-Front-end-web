<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="styles.css" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <!-- dit is de bootstrap link-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"  rel="stylesheet">
  <script>

    function deleteRow(button){
      const row = button.parentNode.parentNode
      row.parentNode.removeChild(row)
      return
    }

    function moveRow(button){
      const row = button.parentNode.parentNode
      const newRow = row.cloneNode(true)
      document.getElementById("approved").appendChild(newRow)
      row.parentNode.removeChild(row)
      return
    }

    //Build tables with fetched reservation, user and book info
    function buildTable(reservation, userData, bookData){
      const table = document.getElementById(reservation.reservationStatus);
      const newRow = table.querySelector('tbody').insertRow();
      const cell1 = newRow.insertCell(0)
      const cell2 = newRow.insertCell(1)
      const cell3 = newRow.insertCell(2)
      const cell4 = newRow.insertCell(3)
      cell1.innerHTML = reservation.id
      cell2.innerHTML = userData.firstName + " " + userData.lastName
      cell3.innerHTML = bookData.title
      cell4.innerHTML = `<button type="button" class="btn btn-primary"><i class="fas fa-check"></i>Approve</button> <button type="button" class="btn btn-danger"><i class="fa-solid fa-trash"></i>Verwijderen</button>`
      const approveButton = cell4.querySelector('button.btn-primary');
      const declineButton = cell4.querySelector('button.btn-danger');
      approveButton.addEventListener('click', () => {
        fetch(`http://localhost:8080/reservation/${reservation.id}`, {
            method: "PUT",
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              reservationStatus: "approved"
            })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          // Return the response to the next .then() block
          return response.json();
        })
        .then(data => {
          // Handle successful response and do something with the data if needed
          console.log('Reservation status updated:', data);

          // Delete the row and get updated reservations
          deleteRow(approveButton);
          getReservations("reservation");
        })
        .catch(error => {
          console.error('Error updating reservation status:', error);
        });
      })
      declineButton.addEventListener('click', () => {
        const confirmation = confirm("Weet je zeker dat je deze reservering wilt verwijderen?")
        if (confirmation){
          fetch(`http://localhost:8080/reservation/${reservation.id}`, {
            method: "DELETE"
            })
          deleteRow(declineButton)
        }
      })
      return
    }

      
    // Triple fetch to get all reservations, user info and book info
    function getReservations(dataToFetch){
      fetch(`http://localhost:8080/${dataToFetch}/all`, {
            method: "GET",
        })
            .then(response => response.json())
            .then(data => {
              data.forEach(item => {
                console.log(item);
                fetch(`http://localhost:8080/user/${item.userId}`, {
                         method: "GET",
                          })
                          .then(response => response.json())
                          .then(userData => {
                            console.log(userData)
                            fetch(`http://localhost:8080/book/${item.bookId}`, {
                              method: "GET",
                            })
                            .then(response => response.json())
                            .then(bookData => {
                              console.log(bookData)
                              buildTable(item, userData, bookData)
                            });
                          });
                        });
                      });
            return;
          }
  </script>
  
  </head>

  <body>
    
    <script>
      // let dataToFetch = "reservation"




      getReservations("reservation")
      getReservations("review")

      
      // dataToFetch.replace("review"
      // getReservations(dataToFetch)
      </script>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <img
          src="https://cdn.thalia.nu/public/thumbnails/partners/logos/WT-Basislogo-RGB_2_medium.png?Key-Pair-Id=K1299LB00EJZ7R"
          alt="WorkingTalent" width="150" 
          />
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="admin-home.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-zoeken.html">Zoeken</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-statistieken.html">Statistieken</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin-account.html">Account</a>
            </li> 
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link" href="index.html">Log Uit</a>
              </li>
            </ul>
        </div>
      </div>
    </nav>

    <!-- zodra goedgekeurd in reserverings naar gereserveerd. 
    zodra uitgeleend in gereserveerd naar uitgeleend-->

    <div class="dashboard-container">
      <h2>Reserveringsverzoeken</h2>
      <table class="table table-striped" id = "unapproved">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Naam</th>
            <th scope="col">Boek</th>
            <th scope="col">Actie</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <br>

      <h2>Reserveringen</h2>
      <table class="table table-striped" id = "approved">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Naam</th>
            <th scope="col">Boek</th>
            <th scope="col">Actie</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <br>
      
      <h2>Uitleningen</h2>
      <table class="table table-striped" id = "borrowed">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Naam</th>
            <th scope="col">Boek</th>
            <th scope="col">Actie</th>
          </tr>
        </thead>
        <tbody>
      </tbody>
      </table>

      <br>

      <h2>Recente reviews</h2>
      <table class="table table-striped" id = "recent-reviews">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Naam</th>
            <th scope="col">Boek</th>
            <th scope="col">Reactie</th>
            <th scope="col">Actie</th>
          </tr>
        </thead>
        <tbody>
      </tbody>
    </div>
    
    <script src="script.js" defer></script>

    <!-- dit is de bootstrap link-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  </body>
</html>