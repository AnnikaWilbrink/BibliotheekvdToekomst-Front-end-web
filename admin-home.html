<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" type="text/css" href="css/styles.css" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <!-- dit is de bootstrap link-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"  rel="stylesheet">
  
    <script src="js/script.js"></script>

  <script>

    let selectedReservationId = 0;

    if (!isAdmin()) {
      window.location.href = '/index.html';
    }

    async function updateReservationStatus(reservation) {
      return new Promise(async (resolve, reject) => {
          try{
            await createBorrowedBook(reservation)
            const response = await fetch(`http://localhost:8080/reservation/${reservation.id}`, {
                  method: "PUT",
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                  borrowed: true
                  })
                })
              if (response.ok) {
                const data = await response.json();
                console.log("Status reservation updated to borrowed:", data);
                resolve(data)
              }
              else{
              console.error("Error updating reservation status to borrowed:", data.statusText);
              reject(data)
            }
            } catch (error) {
            console.error("An error occurred:", error);
            reject(error); // Reject the promise with an error
          }
            
    })
  }

    function selectBookCopy() {
      // Book copy id, reservation id
      let selectedBookCopyId = document.getElementById('selectBookCopy').value;
      alert('selectedBookCopyId', selectedBookCopyId)

      let dto = {
        reservationId: selectedReservationId
      }

      fetch(`http://localhost:8080/bookcopy/${selectedBookCopyId}/select`, {
        method: "PUT",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(dto)
      })
        .then(res => res.json())
        .then(success => {
          jQuery('#selectBookCopyModal').modal('hide');

          buildTables();
          buildBorrowedBooksTable();
        })
    }
           
    function showSelectBookCopy(reservationId, reservationBookId) {
      selectedReservationId = reservationId

      fetch(`http://localhost:8080/book/availability/${reservationBookId}`)
        .then(response => response.json())
        .then(data => {
          if (data.available.length == 0) {
            alert("Er zijn momenteel geen exemplaren beschikbaar!")
          } else {
            let selectBookCopyHtml = ''
            for (let i = 0; i < data.available.length; i++) {
              selectBookCopyHtml += `<option value="${[i+1]}">${data.available[i]}</option>`
            }

            document.getElementById('selectBookCopy').innerHTML = selectBookCopyHtml;

            jQuery('#selectBookCopyModal').modal('show');
          } // else
        }) // then
    }

    function deline(id, reservationApproved ) {
      let confirmation = reservationApproved ? 
        confirm("Weet je zeker dat je deze reservering wilt verwijderen?") :
        confirm("Weet je zeker dat je dit reserveringsverzoek wilt verwijderen?");

      // Deze 6 regels kan in 1 regel
      // if (reservation.approved){
      //   confirmation = confirm("Weet je zeker dat je deze reservering wilt verwijderen?")
      // }
      // if(!reservation.approved){
      //   confirmation = confirm("Weet je zeker dat je dit reserveringsverzoek wilt verwijderen?")
      // }

      if (confirmation) {
        setApproveStatus(id, false);
      }
    }

    function setApproveStatus(id, approved) {
      let dto = {};
      approved ? dto.approved = true : dto.deleted = true;

      fetch(`http://localhost:8080/reservation/${id}`, {
        method: "PUT",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(dto)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        console.log('Reservation status updated');
        getReservations();
      })
      .catch(error => {
        console.error('Error updating reservation status:', error);
      });      
    }

    function buildTables(data) {
      let unapprovedHtml = "";
      let approvedHtml = "";

      data.forEach(reservation => {
        if (reservation.deleted || reservation.borrowed){
          return;
        }

        let callFunction = null;
        if (!reservation.approved) {
          approveButtonText = "Goedkeuren";
          declineButtonText = "Afkeuren";

          callFunction = `setApproveStatus(${reservation.id}, true)`
        }
        if (reservation.approved && !reservation.borrowed) {
          approveButtonText = "Uitlenen";
          declineButtonText = "Verwijderen";

          callFunction = `showSelectBookCopy(${reservation.id}, ${reservation.bookId})`;
        }

        let reservationRowHtml = `
        <tr>
          <td>${reservation.id}</td>
          <td>${reservation.userFirstName} ${reservation.userLastName}</td>
          <td>${reservation.bookTitle}</td>
          <td>
            <button type="button" onclick="${callFunction}" class="btn btn-primary btn-outline-secondary border rounded-pill fw-bold">
              ${approveButtonText}
            </button>
            <button type="button" onclick="decline(${reservation.id}, ${reservation.approved})" class="btn btn-danger btn-outline-secondary border rounded-pill fw-bold">
              ${declineButtonText}
            </button>
          </td>
        </tr>`

        if (!reservation.approved) {
          unapprovedHtml += reservationRowHtml;
        }
        if (reservation.approved && !reservation.borrowed) {
          approvedHtml += reservationRowHtml;
        }
      })

      document.getElementById('unapproved').innerHTML = unapprovedHtml;
      document.getElementById('approved').innerHTML = approvedHtml;
    }

    function buildBorrowedBooksTable(){
      fetch(`http://localhost:8080/borrowed-book/all`, {
        method: "GET",
      })
      .then(response => response.json())
      .then(data => {
        data.forEach(lending => {
          if (lending.returnedDate == null){
            html = "";
            html += `
            <tr>
              <td>${lending.id}</td>
              <td>${lending.userFirstName} ${lending.userLastName}</td>
              <td>${lending.bookTitle}</td>
              <td>${lending.copyNumber}</td>
              <td>
                <button type="button" class="btn btn-greyscale btn-outline-secondary border rounded-pill fw-bold" id="contact_${lending.id}">
                  Contact
                </button>
                <button type="button" class="btn btn-greyscale btn-outline-secondary border rounded-pill fw-bold" id="return_${lending.id}">
                  Stel beschikbaar
                </button>
              </td>
            </tr>`;
            const table = document.getElementById("borrowed");
            table.insertAdjacentHTML('beforeend', html);
            const contactButton = table.querySelector(`#contact_${lending.id}`);
            const returnButton = table.querySelector(`#return_${lending.id}`);
            returnButton.addEventListener('click', () => {
              confirmation = confirm("Weet je zeker dat je deze uitlening weer beschikbaar wilt stellen?")
              if (confirmation){
                fetch(`http://localhost:8080/borrowed-book/${lending.id}`, {
                  method: "PUT",
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                  })
                })
                .then(response => {
                  fetch(`http://localhost:8080/bookcopy/${lending.bookCopyId}`, {
                  method: "PUT",
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    available: true 
                  })
                })
                .then(response => {
                  getReservations();
                  buildBorrowedBooksTable();
                })
              })
            }
          })
          contactButton.addEventListener('click', () => {
            console.log(lending)
            const emailAddress = document.getElementById("recipient-name")
            html = ''
            html += `<span type="text" id="recipient-mail-${lending.userId}">${lending.userEmail}</span>`
            emailAddress.insertAdjacentHTML('beforeend', html)
            jQuery('#contactModal').modal('show');
            // const modalFooter = document.getElementById("contact-modal-footer")
            // console.log("hoi")
            document.getElementById("contactmodalsend").addEventListener("click", function clickHandler() {
              confirmation = confirm("Bevestigen om email te versturen")
              if (confirmation){
                
                const textBody = document.getElementById("message-text").value
                const subjectBody = document.getElementById("subject-text").value
                const email = lending.userEmail
                fetch(`http://localhost:8080/email/send`, {
                  method: "POST",
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    to: email,
                    subject: subjectBody,
                    message: textBody
                  })
              })
              .then(response => response.text())
              .then(data => {
                emailAddress.innerHTML = ''
                document.getElementById("contactmodalsend").removeEventListener("click", clickHandler)
                jQuery('#contactModal').modal('hide');
              }) 
            }
            })
        });
        }
      })
    })
    }

    function getReservations() {
      fetch(`http://localhost:8080/reservation/all`)
        .then(response => response.json())
        .then(data => {
          buildTables(data)
        })
    }

    function getBorrowedBooks(){
      fetch(`http://localhost:8080/borrowed-book/all`)
      .then(response => response.json())
      .then(data => {
        buildBorrowedBooksTable(data)
      })
      return;
    }


    ///////// For review table //////////
       // Function to generate star icons

      function generateStarIcons(num) {
          if (typeof num !== 'number' || num < 0 || num > 5) {
              return 'Invalid input';
          }

          let starsHTML = '';
          for (let i = 1; i <= 5; i++) {
              if (i <= num) {
                  starsHTML += '<i class="bi bi-star-fill text-warning"></i>';
              } else {
                  starsHTML += '<i class="bi bi-star text-warning"></i>';
              }
          }
          return starsHTML;
      }

      async function getReviews() {

        let id = localStorage.getItem("WT_ID");
        console.log("userid for review fetch " + id)

          try {
          const response = await fetch(`http://localhost:8080/review/user/${id}`, {
          method: 'GET',
          });
          
          //if it doesn't work throw error
          if (!response.ok) {
          throw new Error(`Error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log(data)
          return data;
          } catch (error) {
              console.log(error);
          }
      }

      function renderReviews(reviews){

            let table = `
            <table class="table table-striped" id="reviews">
            <thead>
                <tr>
                    <th scope="col"><em>Boek</em></th>
                    <th scope="col"><em>Sterren</em></th>
                    <th scope="col"><em>Text</em></th>
                </tr>
            </thead>
            <tbody>
                    `;
            
            reviews.forEach(review => {
              // const book = getBook(review.bookId)
              // console.log(book)
                table += `
                <tr>
                  <td>${review.bookTitle}</td>
                  <td>${generateStarIcons(review.stars)}</td>
                  <td>${review.text}</td>


            `;});


            table += '</table>';

            const container = document.getElementById('reviewContainer');
            container.innerHTML = table;
        }

        window.onload = function() {
        getReviews().then(data => {
                      renderReviews(data);
        })
        };
      
  </script>
  
  </head>

  <body>
    
    <script>
      getReservations()
      buildBorrowedBooksTable()
    </script>
    <div id="content">
    <div class="dashboard-container">
      <h1>Admin dashboard</h1>

      <h4>Reserveringsverzoeken</h4>
      <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col"><em>#</em></th>
            <th scope="col"><em>Naam</em></th>
            <th scope="col"><em>Boek</em></th>
            <th scope="col"><em>Actie</em></th>
          </tr>
        </thead>
        <tbody id="unapproved">
        </tbody>
      </table>

      <br>

      <h4>Reserveringen</h4>
      <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col"><em>#</em></th>
            <th scope="col"><em>Naam</em></th>
            <th scope="col"><em>Boek</em></th>
            <th scope="col"><em>Actie</em></th>
          </tr>
        </thead>
        <tbody id="approved">
        </tbody>
      </table>

      <br>
      
      <h4>Uitleningen</h4>
      <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col"><em>#</em></th>
            <th scope="col"><em>Naam</em></th>
            <th scope="col"><em>Boek</em></th>
            <th scope="col"><em>Exemplaar</em></th>
            <th scope="col"><em>Actie</em></th>
          </tr>
        </thead>
        <tbody id="borrowed">
        </tbody>
      </table>

      <h4>Mijn reviews</h4>
      <div id="reviewContainer"></div></div>

    </div>

    <!-- Select bookcopy modal -->

    <div class="modal fade" id="selectBookCopyModal" tabindex="-1" role="dialog" aria-labelledby="selectBookCopyModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="selectBookCopyModalLabel">Selecteer exemplaar voor uitlening</h5>
            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <select class="form-select" aria-label="Default select example" id="selectBookCopy">
              <!-- <option selected>Open this select menu</option> -->
            </select>

            <div class="clearfix"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary text-start" data-bs-dismiss="modal">Sluiten</button>
            <button type="button" class="btn btn-primary text-end" onclick="selectBookCopy()">Exemplaar uitlenen</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Contact user modal -->

    <div class="modal fade" id="contactModal" tabindex="-1" role="dialog" aria-labelledby="contactModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="contactModalLabel">New message</h5>
            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="recipient-name" class="col-form-label">Recipient:</label>
                <span type="text" class="form-control" id="recipient-name"></span>
              </div>
              <div class="form-group">
                <label for="subject-text" class="col-form-label">Subject:</label>
                <input type="text" class="form-control" id="subject-text">
              </div>
              <div class="form-group">
                <label for="message-text" class="col-form-label">Message:</label>
                <textarea class="form-control" id="message-text"></textarea>
              </div>
            </form>
          </div>
          <div class="contact-modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="contactmodalclose">Close</button>
            <button type="button" class="btn btn-primary" id = "contactmodalsend">Send message</button>
          </div>
        </div>
      </div>
    </div>
 </div>

    <!-- dit is de bootstrap link-->
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    
    <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script> -->
  </body>
</html>