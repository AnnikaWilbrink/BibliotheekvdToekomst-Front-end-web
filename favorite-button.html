<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <title>Document</title>
    <style>
        .favorite-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
            color: red;
        }

    </style>
    
</head>
<body>
    <table class="table table-striped" id="books-table"></table>
    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script>

        
        function findAll() {
            console.log("start met ophalen")
            fetch("http://localhost:8080/book/all")
                .then(response => response.json())
                .then(data =>{
                    console.log("Data", data);
                    let html = "";
                    data.forEach(book => {
                        html += `
                            <tr>
                                <td>${book.id}</td>
                                <td>${book.title}</td>
                                <td>
                                    <button id="favorite-button${book.id}" class="favorite-button" onclick="saveOrDel(${book.id})">
                                        <i class="far fa-heart"></i>
                                    </button>
                                </td>
                            </tr>
                        `
                    });
                    document.getElementById('books-table').innerHTML = html;
                })
            console.log("Na fetch")    
        }


        function getBooks() {
            let bookids = []; 
            console.log("start met ophalen")
            fetch("http://localhost:8080/book/all")
                .then(response => response.json())
                .then(data =>{
                    data.forEach(book => {
                        bookids.push(book.id);
                    });
                    findAllFavs(bookids);
                })
            console.log("Na fetch") 
        }


        function findAllFavs(bookids) {
            let userId = localStorage.getItem("WT_ID");
            let favids = [];
            console.log("start met ophalen")
            fetch(`http://localhost:8080/favorite/all/${userId}`)
                .then(response => response.json())
                .then(data =>{
                    data.forEach(favorite => {
                        favids.push(favorite.bookId);
                    });
                    console.log("USER:", userId);
                    console.log("FAVBOOKS:", data);
                    console.log(bookids)
                    for (let book of bookids){
                        console.log(book)
                        let favButton = document.getElementById(`favorite-button${book}`);
                        if (favids.includes(book)) {
                            console.log("YES")
                            favButton.innerHTML = '<i class="fas fa-heart"></i>';
                        } else {
                            console.log("NO")
                            favButton.innerHTML = '<i class="far fa-heart"></i>';
                        }
                        
                    }
                })
            console.log("Na fetch")
        }

        function saveFavorite(bookId) {
            let userId = localStorage.getItem("WT_ID");
            
            let obj = {
                "bookId": bookId,
                "userId": userId
            }

            fetch("http://localhost:8080/favorite/save", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": localStorage.getItem("WT_TOKEN")
                },
                body: JSON.stringify(obj)
            })
            .then((response) => response.json())
        }

        function deleteFavorite(bookId) {
            let userId = localStorage.getItem("WT_ID");
            
            let obj = {
                "bookId": bookId,
                "userId": userId
            }
            
            fetch("http://localhost:8080/favorite/delete", {
                method: "DELETE", // Use the HTTP DELETE method to delete the favorite
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": localStorage.getItem("WT_TOKEN")
                },
                body: JSON.stringify(obj)
            })
            .then((response) => {
                if (response.status === 200) {
                    console.log("Favorite deleted successfully");
                } else {
                    console.log("Failed to delete favorite");
                }
            });
        }

        function saveOrDel(bookId){
            let favButton = document.getElementById(`favorite-button${bookId}`);
            let heartIcon = favButton.querySelector("i.fa-heart");
            if (heartIcon.classList.contains("far")) { //Favorites book
                console.log("Favorite")
                heartIcon.classList.remove("far");
                heartIcon.classList.add("fas");
                // Save Book to favorites in db...
                saveFavorite(bookId)

            } else { //Unfavorites book
                console.log("Unfavorite")
                heartIcon.classList.remove("fas");
                heartIcon.classList.add("far");
                // Remove Book from favorites in db...
                deleteFavorite(bookId);
            }
        }

        findAll();
        getBooks();
        
    </script>
    <script src="script.js" defer></script>
</body>
</html>